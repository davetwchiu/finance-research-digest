<!doctype html>
<html>
<head>
  <meta charset='utf-8'>
  <meta name='viewport' content='width=device-width,initial-scale=1'>
  <title>Breaking Alerts</title>
  <link rel="icon" type="image/png" href="../../assets/favicon.png" />
  <style>
    body{font-family:-apple-system,Segoe UI,Roboto,sans-serif;margin:24px;background:#0c1330;color:#e8ecff;line-height:1.5}
    a{color:#9bb8ff}
    li{margin:10px 0}
    .muted{color:#a7b0d6}
    details{margin-top:16px;border:1px solid #2a3768;border-radius:10px;padding:10px 12px;background:#121936}
    summary{cursor:pointer;color:#a7b0d6}
  
    .site-brand{display:flex;align-items:center;gap:10px;margin:0 0 14px 0;padding:8px 10px;border:1px solid #2a3768;border-radius:10px;background:#101a3f}
    .site-brand img{height:28px;width:28px;object-fit:contain;border-radius:6px;background:#eaf0ff;padding:3px}
    .site-brand a{color:#9bb8ff;text-decoration:none;font-size:13px}
  
    #themeToggle{position:fixed;right:14px;bottom:14px;z-index:9999;padding:8px 10px;border-radius:10px;border:1px solid #2a3768;background:#101a3f;color:#e8ecff;font-size:12px;cursor:pointer}
    body.light{background:#f5f7ff !important;color:#0f1b33 !important}
    body.light .card, body.light .topbar, body.light .site-brand, body.light details{background:#ffffff !important;border-color:#d6deef !important;color:#0f1b33 !important}
    body.light .muted, body.light .site-brand a{color:#4b5d85 !important}
    body.light a{color:#2f5bd3 !important}
    body.light #themeToggle{background:#ffffff;color:#0f1b33;border-color:#d6deef}
  </style>
</head>
<body>
  <button id="themeToggle" aria-label="Toggle theme">Theme: AUTO</button>
  <div class="site-brand"><img src="../../assets/brand/logo-mark.png" alt="Atlas Market Intelligence"/><a href="../../index.html">Atlas Market Intelligence</a></div>

  <h1>Breaking Alerts Timeline</h1>
  <p class='muted'>Latest alerts appear first. Each alert is stored as an individual file.</p>

  <h2 style='font-size:18px'>Latest breaking notes</h2>
  <ul id='breakingList'><li class='muted'>Loading timeline...</li></ul>

  <details id='archiveBox' open>
    <summary id='archiveSummary'>Archive (older than 10 days)</summary>
    <ul id='archiveList'><li class='muted'>Loading archive...</li></ul>
  </details>

<script>
function toMs(it){
  if (it.createdAt) {
    const ms = Date.parse(it.createdAt);
    if (Number.isFinite(ms)) return ms;
  }
  if (it.time) {
    const clean = it.time.replace(' HKT','');
    const ms = Date.parse(clean.replace(' ', 'T') + ':00+08:00');
    if (Number.isFinite(ms)) return ms;
  }
  return 0;
}

async function loadBreaking(){
  try{
    const iRes = await fetch('./breaking_index.json?ts='+Date.now(), {cache:'no-store'});
    if(!iRes.ok) throw new Error('missing manifest');
    const idx = await iRes.json();

    const now = Date.now();
    const tenDaysMs = 10 * 24 * 60 * 60 * 1000;
    const items = (idx.items || []).slice().sort((a,b)=>toMs(b)-toMs(a));

    const recent = [];
    const archived = [];
    for (const it of items) {
      const age = now - toMs(it);
      if (age > tenDaysMs) archived.push(it); else recent.push(it);
    }

    const ul = document.getElementById('breakingList');
    ul.innerHTML = '';
    if (!recent.length) {
      ul.innerHTML = '<li class="muted">No recent breaking notes.</li>';
    } else {
      for (const it of recent) {
        const li = document.createElement('li');
        const a = document.createElement('a');
        a.href = it.path;
        a.textContent = `${it.time} — ${it.title}`;
        li.appendChild(a);
        if (it.summary) {
          const d = document.createElement('div');
          d.className = 'muted';
          d.textContent = it.summary;
          li.appendChild(d);
        }
        ul.appendChild(li);
      }
    }
    const back = document.createElement('li');
    const backA = document.createElement('a');
    backA.href='../../index.html'; backA.textContent='← Back to toolbox';
    back.appendChild(backA); ul.appendChild(back);

    const archiveList = document.getElementById('archiveList');
    const archiveSummary = document.getElementById('archiveSummary');
    archiveList.innerHTML = '';
    if (!archived.length) {
      archiveSummary.textContent = 'Archive (older than 10 days) — empty';
      archiveList.innerHTML = '<li class="muted">No archived breaking notes yet.</li>';
    } else {
      archiveSummary.textContent = `Archive (older than 10 days) — ${archived.length} item(s)`;
      for (const it of archived) {
        const li = document.createElement('li');
        const a = document.createElement('a');
        a.href = it.path;
        a.textContent = `${it.time} — ${it.title}`;
        li.appendChild(a);
        archiveList.appendChild(li);
      }
    }
  } catch {
    document.getElementById('breakingList').innerHTML = '<li class="muted">No timeline manifest yet.</li><li><a href="../../index.html">← Back to toolbox</a></li>';
    document.getElementById('archiveList').innerHTML = '<li class="muted">No archive data yet.</li>';
  }
}
loadBreaking();
</script>

<script>
(function(){
  const KEY='ami_theme_mode';
  function saved(){ return localStorage.getItem(KEY)||'auto'; }
  function effective(mode){ if(mode==='auto'){ return window.matchMedia('(prefers-color-scheme: dark)').matches ? 'dark':'light'; } return mode; }
  function apply(){
    const mode=saved();
    const eff=effective(mode);
    document.body.classList.toggle('light', eff==='light');
    const btn=document.getElementById('themeToggle');
    if(btn) btn.textContent='Theme: '+mode.toUpperCase();
    // Keep brand icon consistent across themes (avoid mode flicker/inconsistency).
  }
  function cycle(){ const cur=saved(); const next=cur==='auto'?'dark':cur==='dark'?'light':'auto'; localStorage.setItem(KEY,next); apply(); }
  window.matchMedia('(prefers-color-scheme: dark)').addEventListener?.('change',()=>{ if(saved()==='auto') apply(); });
  const btn=document.getElementById('themeToggle'); if(btn) btn.addEventListener('click',cycle);
  apply();
})();
</script>

</body>
</html>